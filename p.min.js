(function(e){if(typeof module!=="undefined"&&module&&module.exports){module.exports=e()}else if(typeof define==="function"&&define.amd){define(e)}else{P=e()}})(function(){"use strict";var e=h(typeof process)&&process!=null&&{}.toString.call(process)==="[object process]",t=typeof setImmediate==="function",n=h(typeof MutationObserver)&&MutationObserver||h(typeof WebKitMutationObserver)&&WebKitMutationObserver,i=new p,r=i,o=false,u=e?P:n?T(m):j(m),a=[],s=j(_),f,c,d=h.call,v=h.apply;r.next=i;function p(){this.task=null;this.domain=null;this.a=null;this.b=null;this.next=null}function h(e){return e==="object"||e==="function"}function _(){if(a.length){throw a.shift()}}function m(){while(i!==r){i=i.next;var e=i.task;if(i.domain){b(i.domain,e,i.a,i.b,void 0);i.domain=null}else{e(i.a,i.b)}i.task=null;i.a=null;i.b=null}o=false}function y(){i.task=null;i.domain=null;i.a=null;i.b=null;u()}function b(e,t,n,i,r){if(e._disposed){return}e.enter();t(n,i,r);e.exit()}function g(t,n,l,a,s){var f=r.next;if(f===i){f=new p;if(!t){r=r.next=f;f.next=i}}else if(t){r.next=f.next;f.next=null}else{r=f}f.task=l;f.a=a;f.b=s;if(n&&e){f.domain=process.domain}if(t){if(t._lastPending){t._lastPending.next=f}else{t._firstPending=f}t._lastPending=f}else if(!o){o=true;u()}return f}function w(e){var t=r.next;r.next=e._firstPending;r=e._lastPending;r.next=t;e._firstPending=null;e._lastPending=null;if(!o){o=true;u()}}function P(){var e=process.domain;if(e){if(!c)c=(1,require)("domain");c.active=process.domain=null}if(o&&t){setImmediate(m)}else{process.nextTick(m)}if(e){c.active=process.domain=e}}function T(e){var t=1;var i=document.createTextNode("");var r=new n(e);r.observe(i,{characterData:true});return function(){t=-t;i.data=t}}function j(e){return function(){var t=setTimeout(i,0);var n=setInterval(i,50);function i(){clearTimeout(t);clearInterval(n);e()}}}if(e){f=function(e){y();throw e}}else{f=function(e){a.push(e);s()}}function k(e,t){try{e.call()}catch(n){f(n)}}function O(e){g(null,true,k,e,void 0)}function I(e,t){for(var n=0,i=e.length;n<i;++n){if(n in e){t(e[n],n)}}}function M(e){if(S.onerror){try{S.onerror.call(null,e)}catch(t){f(t)}}else{f(e)}}var E=0;var A=1;var K=2;function S(e){return e instanceof C?e:D(new C,e)}function W(t,n,i){if(t._state){return t}t._state=n;t._value=i;if(n===K&&e){t._domain=process.domain}if(t._firstPending){w(t)}return t}function q(e,t){if(t._state){return t}t._state=e._state;t._value=e._value;t._domain=e._domain;if(t._firstPending){w(t)}return t}function D(e,t,n){if(e._state){return e}if(t instanceof C){if(t===e){W(e,K,new TypeError("You can't resolve a promise with itself"))}else if(t._state){q(t,e)}else{g(t,false,q,t,e)}}else if(t!==Object(t)){W(e,A,t)}else if(n){N(e,t)}else{g(null,true,N,e,t)}return e}function N(e,t){var n,i;try{i=t.then}catch(r){W(e,K,r);return}if(typeof i==="function"){n=Y(e);try{d.call(i,t,n.resolve,n.reject)}catch(o){n.reject(o)}}else{W(e,A,t)}}function Y(e){var t=false;return{promise:e,resolve:function(n){if(!t){t=true;D(e,n,false)}},reject:function(n){if(!t){t=true;W(e,K,n)}}}}S.defer=z;function z(){return Y(new C)}S.reject=B;function B(e){return W(new C,K,e)}function C(){this._state=0;this._value=void 0;this._domain=null;this._cb=null;this._eb=null;this._firstPending=null;this._lastPending=null}C.prototype.then=function(t,n){var i=new C;i._cb=typeof t==="function"?t:null;i._eb=typeof n==="function"?n:null;i._domain=e?process.domain:null;g(this._state===E?this:null,false,F,this,i);return i};function F(e,t){var n=e._state===A?t._cb:t._eb;t._cb=null;t._eb=null;if(!n){q(e,t);return}var i=e._domain||t._domain;if(i){t._domain=null;b(i,G,n,t,e._value)}else{G(n,t,e._value)}}function G(e,t,n){var i;try{i=e(n)}catch(r){W(t,K,r);return}D(t,i,true)}C.prototype.done=function(e,t){var n=this;if(e||t){n=n.then(e,t)}n.then(null,M)};C.prototype.fail=function(e){return this.then(null,e)};C.prototype.spread=function(e,t){return this.then(e&&function(n){return J(n).then(function(t){return v.call(e,void 0,t)},t)},t)};C.prototype.timeout=function(e,t){var n=this;var i=new C;if(n._state!==E){q(n,i)}else{var r=setTimeout(function(){W(i,K,new Error(t||"Timed out after "+e+" ms"))},e);g(n,false,function(){clearTimeout(r);q(n,i)},void 0,void 0)}return i};C.prototype.delay=function(e){var t=z();this.then(function(n){setTimeout(function(){t.resolve(n)},e)},t.reject);return t.promise};C.prototype.inspect=function(){switch(this._state){case E:return{state:"pending"};case A:return{state:"fulfilled",value:this._value};case K:return{state:"rejected",reason:this._value};default:throw new TypeError("invalid state")}};S.allSettled=H;function H(e){var t=0;var n=new C;var i=new Array(e.length);function r(e,r){i[r]=e.inspect();if(--t===0){W(n,A,i)}}for(var o=0;l=e.length;++o){var u=S(x);if(u._state===E){++t;g(u,false,r,u,o)}else{i[o]=u.inspect()}}if(t===0){W(n,A,i)}return n}S.all=J;function J(e){var t=0;var n=z();var i=new Array(e.length);I(e,function(e,r){var o=S(e);if(o._state===A){i[r]=o._value}else{++t;o.then(function(e){i[r]=e;if(--t===0){n.resolve(i)}},n.reject)}});if(t===0){n.resolve(i)}return n.promise}S.promised=L;function L(e){function t(t){return v.apply(e,t)}return function(){return J([this,J(arguments)]).then(t)}}S.onerror=null;S.nextTick=O;return S});