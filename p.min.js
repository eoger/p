(function(e){if(typeof module!=="undefined"&&module&&module.exports){module.exports=e()}else if(typeof define==="function"&&define.amd){define(e)}else{P=e()}})(function(){"use strict";var e=v(typeof process)&&process!=null&&{}.toString.call(process)==="[object process]",n=typeof setImmediate==="function",t=v(typeof MutationObserver)&&MutationObserver||v(typeof WebKitMutationObserver)&&WebKitMutationObserver,i=new p,r=i,o=false,u=e?w:t?g(_):x(_),a=[],s=x(h),l,f,c=v.call,d=v.apply;r.next=i;function p(){this.task=null;this.domain=null;this.a=null;this.b=null;this.next=null}function v(e){return e==="object"||e==="function"}function h(){if(a.length){throw a.shift()}}function _(){while(i!==r){i=i.next;var e=i.task;if(M.countFreeTaskNodes>=1024){r.next=r.next.next}else{++M.countFreeTaskNodes}if(i.domain){y(i.domain,e,i.a,i.b,void 0);i.domain=null}else{e(i.a,i.b)}i.task=null;i.a=null;i.b=null}o=false}function m(){i.task=null;i.domain=null;i.a=null;i.b=null;u()}function y(e,n,t,i,r){if(e._disposed){return}e.enter();n(t,i,r);e.exit()}function b(n,t,a,s){var l=r.next;if(l===i){l=new p;r.next=l;l.next=i}else{--M.countFreeTaskNodes}r=l;l.task=t;l.a=a;l.b=s;if(n&&e){l.domain=process.domain}if(!o){o=true;u()}}function w(){var e=process.domain;if(e){if(!f)f=(1,require)("domain");f.active=process.domain=null}if(o&&n){setImmediate(_)}else{process.nextTick(_)}if(e){f.active=process.domain=e}}function g(e){var n=1;var i=document.createTextNode("");var r=new t(e);r.observe(i,{characterData:true});return function(){n=-n;i.data=n}}function x(e){return function(){var n=setTimeout(i,0);var t=setInterval(i,50);function i(){clearTimeout(n);clearInterval(t);e()}}}if(e){l=function(e){m();throw e}}else{l=function(e){a.push(e);s()}}function T(e,n){try{e.call()}catch(t){n(t)}}function k(e){b(true,T,e,l)}function j(e,n){for(var t=0,i=e.length;t<i;++t){if(t in e){n(e[t],t)}}}function N(e){k(function(){if(M.onerror){M.onerror.call(null,e)}else{throw e}})}var O=0;var F=1;var I=2;function M(e){return e instanceof C?e:K(new C,e,false)}M.countFreeTaskNodes=0;function E(n,t,i){if(n._state){return n}n._state=t;n._value=i;if(t===I&&e){n._domain=process.domain}if(n._pending){W(n)}return n}function A(e,n){if(n._state){return n}n._state=e._state;n._value=e._value;n._domain=e._domain;if(n._pending){W(n)}return n}function K(e,n,t){if(e._state){return e}if(n instanceof C){if(n===e){E(e,I,new TypeError("You can't resolve a promise with itself"))}else if(n._state){A(n,e)}else{q(e,n)}}else if(n!==Object(n)){E(e,F,n)}else if(t){S(e,n)}else{b(true,S,e,n)}return e}function S(e,n){var t,i;try{i=n.then}catch(r){E(e,I,r);return}if(typeof i==="function"){t=Y(e);try{c.call(i,n,t.resolve,t.reject)}catch(o){t.reject(o)}}else{E(e,F,n)}}function W(e){var n=e._pending;e._pending=null;if(n instanceof C){b(false,D,e,n);return}for(var t=0,i=n.length;t<i;++t){b(false,D,e,n[t])}}function q(e,n){if(!n._pending){n._pending=e}else if(n._pending instanceof C){n._pending=[n._pending,e]}else{n._pending.push(e)}}function D(e,n){var t=e._state===F?n._cb:n._eb;n._cb=null;n._eb=null;if(!t){A(e,n);return}var i=e._domain||n._domain;if(i){n._domain=null;y(i,P,t,n,e._value)}else{P(t,n,e._value)}}function P(e,n,t){var i;try{i=e(t)}catch(r){E(n,I,r);return}K(n,i,true)}function Y(e){var n=false;return{promise:e,resolve:function(t){if(!n){n=true;K(e,t,false)}},reject:function(t){if(!n){n=true;E(e,I,t)}}}}M.defer=z;function z(){return Y(new C)}M.reject=B;function B(e){return E(new C,I,e)}function C(){this._state=0;this._value=void 0;this._domain=null;this._cb=null;this._eb=null;this._pending=null}C.prototype.then=function(n,t){var i=new C;i._cb=typeof n==="function"?n:null;i._eb=typeof t==="function"?t:null;i._domain=e?process.domain:null;if(this._state===O){q(i,this)}else{b(false,D,this,i)}return i};C.prototype.done=function(e,n){var t=this;if(e||n){t=t.then(e,n)}t.then(null,N)};C.prototype.fail=function(e){return this.then(null,e)};C.prototype._always=function(e){return this.then(e,e)};C.prototype.spread=function(e,n){return this.then(e&&function(t){return H(t).then(function(n){return d.call(e,void 0,n)},n)},n)};C.prototype.timeout=function(e,n){var t=this;var i=new C;if(t._state!==O){A(t,i)}else{var r=setTimeout(function(){E(i,I,new Error(n||"Timed out after "+e+" ms"))},e);t._always(function(){clearTimeout(r);A(t,i)})}return i};C.prototype.delay=function(e){var n=z();this.then(function(t){setTimeout(function(){n.resolve(t)},e)},n.reject);return n.promise};C.prototype.inspect=function(){switch(this._state){case O:return{state:"pending"};case F:return{state:"fulfilled",value:this._value};case I:return{state:"rejected",reason:this._value};default:throw new TypeError("invalid state")}};M.allSettled=G;function G(e){var n=0;var t=new C;var i=new Array(e.length);j(e,function(e,r){var o=M(e);if(o._state===O){++n;o._always(function(){i[r]=o.inspect();if(--n===0){E(t,F,i)}})}else{i[r]=o.inspect()}});if(n===0){E(t,F,i)}return t}M.all=H;function H(e){var n=0;var t=z();var i=new Array(e.length);j(e,function(e,r){var o=M(e);if(o._state===F){i[r]=o._value}else{++n;o.then(function(e){i[r]=e;if(--n===0){t.resolve(i)}},t.reject)}});if(n===0){t.resolve(i)}return t.promise}M.promised=J;function J(e){function n(n){return d.apply(e,n)}return function(){return H([this,H(arguments)]).then(n)}}M.onerror=null;M.nextTick=k;return M});