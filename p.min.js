(function(e){if(typeof module!=="undefined"&&module&&module.exports){module.exports=e()}else if(typeof define==="function"&&define.amd){define(e)}else{P=e()}})(function(){"use strict";var e={f:null,w:false,n:null},n=e,t=true,r=0,o=0,i,f,u=p(typeof window)&&window||p(typeof worker)&&worker,c=e.toString,s;function a(){--r;while(e.n){e=e.n;if(e.w){--o}var n=e.f;e.f=null;n()}t=true}var l=function(e,i){if(t&&++o>r){++r;f(a,0)}n=n.n={f:e,w:t,n:null};t=i===true};function p(e){return e==="object"||e==="function"}function v(e){return e==="function"}if(v(typeof setImmediate)){f=u?function(e){u.setImmediate(e)}:function(e){setImmediate(e)}}else if(p(typeof process)&&process&&v(typeof process.nextTick)){f=process.nextTick}else if(v(typeof MessageChannel)){i=new MessageChannel;i.port1.onmessage=a;f=function(){i.port2.postMessage(0)}}else{f=setTimeout;if(u&&p(typeof Image)&&Image){(function(){var e=0;var n=function(e){var n=new Image;n.onerror=e;n.src="data:image/png,"};try{n(function(){if(--e===0){f=n}});++e}catch(t){}e&&setTimeout(function(){e=0},0)})()}}function m(e){l(function(){if(h.onerror){h.onerror(e)}else{throw e}},true)}s=Array.isArray||function(e){return!!e&&c.call(e)==="[object Array]"};function y(e,n){for(var t=0,r=e.length;t<r;++t){if(t in e){n(e[t],t)}}}function d(e,n){if(s(e)){y(e,n);return}for(var t in e){n(e[t],t)}}function h(e){if(e instanceof k){return e}var n=I();n.resolve(e);return n.promise}var w={};var g=0;var T=1;var j=2;h.defer=I;function I(){var e=[],n=0,t=0,r=false,o;function i(e){var r=n;return function(n){t=r;u(n,w,e)}}function f(n,t,i,f){var u=i===w?void 0:I();function c(){var e=r?n:t;if(typeof e==="function"){try{var i=e(o)}catch(f){u?u.reject(f):m(f);return}u&&u.resolve(i)}else if(u){u.resolve(o,w,r?T:j)}else if(!r){m(o)}}if(e){e.push(c)}else if(f===w){c()}else{l(c)}return u&&u.promise}function u(f,c,s){if(t!==n){return}++n;s=c===w&&s;if(s||f!==Object(f)){r=s!==j;o=f;y(e,l);e=null;return}if(f instanceof k){f.then(i(T),i(j),w,w);return}l(function(){var e=0;try{var r=f.then;if(typeof r==="function"){r.call(f,i(g),i(j))}else{e=T}}catch(o){f=o;e=j}if(e){t=n;u(f,w,e)}})}return{promise:new k(f),resolve:u,reject:i(j)}}function k(e){this.then=e}k.prototype.done=function(e,n){this.then(e,n,w)};k.prototype.spread=function(e,n){return this.then(e&&function(n){return x(n).then(function(n){return e.apply(void 0,n)})},n)};k.prototype.timeout=function(e){var n=I();var t=setTimeout(function(){n.reject(new Error("Timed out after "+e+" ms"))},e);this.then(function(e){clearTimeout(t);n.resolve(e)},function(e){clearTimeout(t);n.reject(e)},w,w);return n.promise};k.prototype.delay=function(e){var n=this;var t=I();setTimeout(function(){t.resolve(n)},e);return t.promise};h.all=x;function x(e){var n=1;var t=I();d(e,function(r,o){++n;h(r).then(function(r){e[o]=r;if(--n===0){t.resolve(e)}},t.reject,w,w)});if(--n===0){t.resolve(e)}return t.promise}h.onerror=null;h.prototype=k.prototype;h.nextTick=function(e){l(e,true)};h._each=d;return h});