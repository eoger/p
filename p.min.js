(function(e){if(typeof module!=="undefined"&&module&&module.exports){module.exports=e()}else if(typeof define==="function"&&define.amd){define(e)}else{P=e()}})(function(){"use strict";var e=p(typeof process)&&process!=null&&{}.toString.call(process)==="[object process]",n=typeof setImmediate==="function",t=p(typeof MutationObserver)&&MutationObserver||p(typeof WebKitMutationObserver)&&WebKitMutationObserver,i=new h,r=i,o=false,u=e?P:t?T(m):j(m),a=[],s=j(_),f,c,d=p.call,v=p.apply;r.next=i;function h(){this.task=null;this.domain=null;this.a=null;this.b=null;this.next=null}function p(e){return e==="object"||e==="function"}function _(){if(a.length){throw a.shift()}}function m(){while(i!==r){i=i.next;var e=i.task;if(i.domain){w(i.domain,e,i.a,i.b);i.domain=null}else{e(i.a,i.b)}i.task=null;i.a=null;i.b=null}o=false}function y(e,n){var t=r.next;r.next=e;r=n||e;r.next=t;if(!o){o=true;u()}}function b(){i.task=null;i.domain=null;i.a=null;i.b=null;u()}function w(e,n,t,i){if(e._disposed){return}e.enter();n(t,i);e.exit()}function g(n,t,l,a,s){var f=r.next;if(f===i){f=new h;if(!n){r=r.next=f;f.next=i}}else if(n){r.next=f.next;f.next=null}else{r=f}f.task=l;f.a=a;f.b=s;if(t&&e){f.domain=process.domain}if(n){if(n._lastPending){n._lastPending.next=f}else{n._firstPending=f}n._lastPending=f}else if(!o){o=true;u()}return f}function P(){var e=process.domain;if(e){if(!c)c=(1,require)("domain");c.active=process.domain=null}if(o&&n){setImmediate(m)}else{process.nextTick(m)}if(e){c.active=process.domain=e}}function T(e){var n=1;var i=document.createTextNode("");var r=new t(e);r.observe(i,{characterData:true});return function(){n=-n;i.data=n}}function j(e){return function(){var n=setTimeout(i,0);var t=setInterval(i,50);function i(){clearTimeout(n);clearInterval(t);e()}}}if(e){f=function(e){try{e.call()}catch(n){b();throw n}}}else{f=function(e){try{e.call()}catch(n){a.push(n);s()}}}function k(e){g(null,true,f,e,void 0)}function O(e,n){for(var t=0,i=e.length;t<i;++t){if(t in e){n(e[t],t)}}}function I(e){k(function(){if(K.onerror){K.onerror.call(null,e)}else{throw e}})}var M=0;var E=1;var A=2;function K(e){return e instanceof B?e:q(new B,e)}function S(n,t,i){if(n._state){return n}n._state=t;n._value=i;if(t===A&&!n._domain&&e){n._domain=process.domain}if(n._firstPending){y(n._firstPending,n._lastPending);n._firstPending=null;n._lastPending=null}return n}function W(e,n){n._domain=e._domain;S(n,e._state,e._value)}function q(e,n,t){if(e._state){return e}if(n instanceof B){if(n===e){S(e,A,new TypeError("You can't resolve a promise with itself"))}else if(n._state){W(n,e)}else{g(n,false,W,n,e)}}else if(n!==Object(n)){S(e,E,n)}else if(t){D(e,n)}else{g(null,true,D,e,n)}return e}function D(e,n){var t,i;try{i=n.then}catch(r){S(e,A,r);return}if(typeof i==="function"){t=N(e);try{d.call(i,n,t.resolve,t.reject)}catch(o){t.reject(o)}}else{S(e,E,n)}}function N(e){var n=false;return{promise:e,resolve:function(t){if(!n){n=true;q(e,t,false)}},reject:function(t){if(!n){n=true;S(e,A,t)}}}}K.defer=Y;function Y(){return N(new B)}K.reject=z;function z(e){return S(new B,A,e)}function B(){this._state=0;this._value=void 0;this._domain=null;this._cb=null;this._eb=null;this._firstPending=null;this._lastPending=null}B.prototype.then=function(n,t){var i=new B;i._cb=typeof n==="function"?n:null;i._eb=typeof t==="function"?t:null;i._domain=e?process.domain:null;g(this._state===M?this:null,false,C,this,i);return i};function C(e,n){var t=e._state===E?n._cb:n._eb;n._cb=null;n._eb=null;if(!t){W(e,n);return}n._value=e._value;var i=e._domain||n._domain;if(i){n._domain=null;w(i,F,t,n)}else{F(t,n)}}function F(e,n){var t;try{t=e(n._value)}catch(i){S(n,A,i);return}q(n,t,true)}B.prototype.done=function(e,n){var t=this;if(e||n){t=t.then(e,n)}t.then(null,I)};B.prototype.fail=function(e){return this.then(null,e)};B.prototype.spread=function(e,n){return this.then(e&&function(t){return H(t,[]).then(function(n){return v.call(e,void 0,n)},n)},n)};B.prototype.timeout=function(e,n){var t=this;var i=new B;if(t._state!==M){W(t,i)}else{var r=setTimeout(function(){S(i,A,new Error(n||"Timed out after "+e+" ms"))},e);g(t,false,function(){clearTimeout(r);W(t,i)},void 0,void 0)}return i};B.prototype.delay=function(e){var n=Y();this.then(function(t){setTimeout(function(){n.resolve(t)},e)},n.reject);return n.promise};B.prototype.inspect=function(){switch(this._state){case M:return{state:"pending"};case E:return{state:"fulfilled",value:this._value};case A:return{state:"rejected",reason:this._value};default:throw new TypeError("invalid state")}};K.allSettled=G;function G(e){var n=0;var t=new B;var i=new Array(e.length);function r(e,r){i[r]=e.inspect();if(--n===0){S(t,E,i)}}for(var o=0;l=e.length;++o){var u=K(x);if(u._state===M){++n;g(u,false,r,u,o)}else{i[index]=u.inspect()}}if(n===0){S(t,E,i)}return t}K.all=H;function H(e){var n=0;var t=Y();var i=new Array(e.length);O(e,function(e,r){var o=K(e);if(o._state===E){i[r]=o._value}else{++n;o.then(function(e){i[r]=e;if(--n===0){t.resolve(i)}},t.reject)}});if(n===0){t.resolve(i)}return t.promise}K.promised=J;function J(e){function n(n){return v.apply(e,n)}return function(){return H([this,H(arguments)]).then(n)}}K.onerror=null;K.nextTick=k;return K});