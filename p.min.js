(function(e){if(typeof module!=="undefined"&&module&&module.exports){module.exports=e()}else if(typeof define==="function"&&define.amd){define(e)}else{P=e()}})(function(){"use strict";var e=h(typeof process)&&process!=null&&{}.toString.call(process)==="[object process]",n=typeof setImmediate==="function",t=h(typeof MutationObserver)&&MutationObserver||h(typeof WebKitMutationObserver)&&WebKitMutationObserver,i=new p,r=i,o=false,u=e?P:t?T(m):j(m),a=[],s=j(_),f,c,d=h.call,v=h.apply;r.next=i;function p(){this.task=null;this.domain=null;this.a=null;this.b=null;this.next=null}function h(e){return e==="object"||e==="function"}function _(){if(a.length){throw a.shift()}}function m(){while(i!==r){i=i.next;var e=i.task;if(i.domain){b(i.domain,e,i.a,i.b,void 0);i.domain=null}else{e(i.a,i.b)}i.task=null;i.a=null;i.b=null}o=false}function y(){i.task=null;i.domain=null;i.a=null;i.b=null;u()}function b(e,n,t,i,r){if(e._disposed){return}e.enter();n(t,i,r);e.exit()}function w(n,t,l,a,s){var f=r.next;if(f===i){f=new p;if(!n){r=r.next=f;f.next=i}}else if(n){r.next=f.next;f.next=null}else{r=f}f.task=l;f.a=a;f.b=s;if(t&&e){f.domain=process.domain}if(n){if(n._lastPending){n._lastPending.next=f}else{n._firstPending=f}n._lastPending=f}else if(!o){o=true;u()}return f}function g(e){var n=r.next;r.next=e._firstPending;r=e._lastPending;r.next=n;e._firstPending=null;e._lastPending=null;if(!o){o=true;u()}}function P(){var e=process.domain;if(e){if(!c)c=(1,require)("domain");c.active=process.domain=null}if(o&&n){setImmediate(m)}else{process.nextTick(m)}if(e){c.active=process.domain=e}}function T(e){var n=1;var i=document.createTextNode("");var r=new t(e);r.observe(i,{characterData:true});return function(){n=-n;i.data=n}}function j(e){return function(){var n=setTimeout(i,0);var t=setInterval(i,50);function i(){clearTimeout(n);clearInterval(t);e()}}}if(e){f=function(e){y();throw e}}else{f=function(e){a.push(e);s()}}function k(e,n){try{e.call()}catch(t){n(t)}}function O(e){w(null,true,k,e,f)}function I(e,n){for(var t=0,i=e.length;t<i;++t){if(t in e){n(e[t],t)}}}function M(e){O(function(){if(S.onerror){S.onerror.call(null,e)}else{throw e}})}var E=0;var A=1;var K=2;function S(e){return e instanceof C?e:D(new C,e)}function W(n,t,i){if(n._state){return n}n._state=t;n._value=i;if(t===K&&e){n._domain=process.domain}if(n._firstPending){g(n)}return n}function q(e,n){if(n._state){return n}n._state=e._state;n._value=e._value;n._domain=e._domain;if(n._firstPending){g(n)}return n}function D(e,n,t){if(e._state){return e}if(n instanceof C){if(n===e){W(e,K,new TypeError("You can't resolve a promise with itself"))}else if(n._state){q(n,e)}else{w(n,false,q,n,e)}}else if(n!==Object(n)){W(e,A,n)}else if(t){N(e,n)}else{w(null,true,N,e,n)}return e}function N(e,n){var t,i;try{i=n.then}catch(r){W(e,K,r);return}if(typeof i==="function"){t=Y(e);try{d.call(i,n,t.resolve,t.reject)}catch(o){t.reject(o)}}else{W(e,A,n)}}function Y(e){var n=false;return{promise:e,resolve:function(t){if(!n){n=true;D(e,t,false)}},reject:function(t){if(!n){n=true;W(e,K,t)}}}}S.defer=z;function z(){return Y(new C)}S.reject=B;function B(e){return W(new C,K,e)}function C(){this._state=0;this._value=void 0;this._domain=null;this._cb=null;this._eb=null;this._firstPending=null;this._lastPending=null}C.prototype.then=function(n,t){var i=new C;i._cb=typeof n==="function"?n:null;i._eb=typeof t==="function"?t:null;i._domain=e?process.domain:null;w(this._state===E?this:null,false,F,this,i);return i};function F(e,n){var t=e._state===A?n._cb:n._eb;n._cb=null;n._eb=null;if(!t){q(e,n);return}var i=e._domain||n._domain;if(i){n._domain=null;b(i,G,t,n,e._value)}else{G(t,n,e._value)}}function G(e,n,t){var i;try{i=e(t)}catch(r){W(n,K,r);return}D(n,i,true)}C.prototype.done=function(e,n){var t=this;if(e||n){t=t.then(e,n)}t.then(null,M)};C.prototype.fail=function(e){return this.then(null,e)};C.prototype.spread=function(e,n){return this.then(e&&function(t){return J(t).then(function(n){return v.call(e,void 0,n)},n)},n)};C.prototype.timeout=function(e,n){var t=this;var i=new C;if(t._state!==E){q(t,i)}else{var r=setTimeout(function(){W(i,K,new Error(n||"Timed out after "+e+" ms"))},e);w(t,false,function(){clearTimeout(r);q(t,i)},void 0,void 0)}return i};C.prototype.delay=function(e){var n=z();this.then(function(t){setTimeout(function(){n.resolve(t)},e)},n.reject);return n.promise};C.prototype.inspect=function(){switch(this._state){case E:return{state:"pending"};case A:return{state:"fulfilled",value:this._value};case K:return{state:"rejected",reason:this._value};default:throw new TypeError("invalid state")}};S.allSettled=H;function H(e){var n=0;var t=new C;var i=new Array(e.length);function r(e,r){i[r]=e.inspect();if(--n===0){W(t,A,i)}}for(var o=0;l=e.length;++o){var u=S(x);if(u._state===E){++n;w(u,false,r,u,o)}else{i[o]=u.inspect()}}if(n===0){W(t,A,i)}return t}S.all=J;function J(e){var n=0;var t=z();var i=new Array(e.length);I(e,function(e,r){var o=S(e);if(o._state===A){i[r]=o._value}else{++n;o.then(function(e){i[r]=e;if(--n===0){t.resolve(i)}},t.reject)}});if(n===0){t.resolve(i)}return t.promise}S.promised=L;function L(e){function n(n){return v.apply(e,n)}return function(){return J([this,J(arguments)]).then(n)}}S.onerror=null;S.nextTick=O;return S});